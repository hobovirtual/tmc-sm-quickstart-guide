#@ load("@ytt:data", "data")
#@ load("@ytt:base64", "base64")
---
apiVersion: v1
kind: Secret
metadata:
  name: #@ "{}-user-trusted-ca-secret".format(data.values.cluster.name)
  namespace: #@ "{}".format(data.values.cluster.namespace)
type: Opaque
data:
  harbor-ca: #@ base64.encode(base64.encode(data.values.trusted.harbor))
  tmc-ca: #@ base64.encode(base64.encode(data.values.trusted.ca))
---
apiVersion: run.tanzu.vmware.com/v1alpha3
kind: KappControllerConfig
metadata:
  name: #@ "{}-kapp-controller-package".format(data.values.cluster.name)
  namespace: #@ "{}".format(data.values.cluster.namespace)
spec:
  kappController:
    createNamespace: false
    config:
      caCerts: #@ "{}".format(data.values.trusted.harbor)
      dangerousSkipTLSVerify: ""
      httpProxy: ""
      httpsProxy: ""
      noProxy: ""
    deployment:
      apiPort: 10100
      concurrency: 4
      hostNetwork: true
      metricsBindAddress: "0"
      priorityClassName: system-cluster-critical
      tolerations:
      - key: CriticalAddonsOnly
        operator: Exists
      - effect: NoSchedule
        key: node-role.kubernetes.io/control-plane
      - effect: NoSchedule
        key: node-role.kubernetes.io/master
      - effect: NoSchedule
        key: node.kubernetes.io/not-ready
      - effect: NoSchedule
        key: node.cloudprovider.kubernetes.io/uninitialized
        value: "true"
    globalNamespace: tkg-system
  namespace: tkg-system
